import streamlit as st
import pandas as pd

# ---------------------------------------------------------
# 1. 정답 데이터베이스 (이미지 분석 데이터)
# ---------------------------------------------------------
EXAM_DB = {
    "진도별 모의고사": {
        1: [1, 1, 2, 1, 4, 3, 2, 2, 3, 3, 2, 4, 4, 3, 3, 3, 2, 3, 3, 2],
        2: [3, 1, 3, 2, 4, 1, 2, 4, 3, 2, 4, 2, 3, 1, 4, 2, 4, 3, 2, 2],
        3: [2, 2, 1, 3, 2, 2, 3, 2, 3, 4, 1, 3, 4, 2, 2, 4, 3, 2, 2, 4],
        4: [4, 2, 4, 1, 2, 1, 2, 3, 3, 3, 2, 3, 2, 1, 1, 4, 3, 4, 1, 2],
        5: [1, 2, 2, 2, 2, 4, 2, 3, 3, 2, 1, 4, 3, 2, 4, 4, 3, 2, 3, 3],
        6: [3, 1, 4, 3, 1, 1, 1, 4, 4, 4, 2, 1, 4, 4, 4, 2, 2, 3, 2, 3],
        7: [3, 4, 1, 3, 3, 3, 3, 3, 4, 1, 4, 3, 3, 1, 2, 3, 2, 4, 1, 2],
        8: [1, 3, 3, 1, 3, 3, 3, 2, 4, 2, 2, 3, 2, 2, 1, 4, 3, 1, 3, 4],
        9: [2, 2, 4, 4, 3, 2, 4, 4, 3, 3, 4, 2, 2, 3, 2, 3, 3, 1, 2, 2],
        10: [2, 3, 3, 4, 3, 2, 2, 3, 2, 4, 2, 2, 3, 2, 1, 4, 3, 1, 1, 3],
        11: [1, 2, 3, 4, 1, 2, 1, 4, 4, 3, 3, 2, 4, 4, 4, 4, 3, 4, 3, 3],
        12: [3, 1, 4, 3, 2, 4, 1, 1, 4, 1, 2, 4, 2, 3, 2, 2, 4, 4, 1, 4],
    },
    "동형 모의고사": {
        1: [2, 3, 4, 4, 3, 1, 2, 3, 4, 2, 2, 3, 2, 3, 1, 4, 4, 4, 1, 3],
        2: [2, 2, 4, 3, 3, 4, 3, 3, 2, 1, 1, 1, 3, 4, 4, 2, 3, 1, 1, 3],
        3: [2, 2, 3, 4, 3, 4, 1, 2, 3, 2, 2, 1, 4, 4, 1, 2, 4, 3, 1, 2],
        4: [4, 1, 2, 2, 2, 4, 2, 3, 4, 2, 3, 4, 4, 1, 1, 4, 4, 4, 4, 1],
        5: [2, 4, 2, 2, 4, 4, 3, 4, 4, 4, 4, 3, 4, 4, 2, 2, 4, 3, 1, 1],
        6: [2, 3, 4, 2, 2, 3, 3, 4, 4, 1, 4, 2, 1, 2, 1, 2, 3, 3, 4, 1],
        7: [1, 2, 3, 4, 3, 3, 2, 2, 3, 4, 2, 1, 3, 3, 4, 4, 3, 2, 2, 2],
        8: [2, 2, 3, 3, 3, 4, 3, 4, 3, 3, 2, 3, 1, 1, 2, 4, 1, 3, 4, 3],
        9: [2, 4, 3, 1, 1, 4, 3, 3, 4, 3, 1, 3, 2, 1, 1, 1, 2, 1, 4, 1],
        10: [1, 1, 3, 3, 4, 4, 4, 3, 2, 3, 1, 3, 3, 4, 2, 1, 3, 1, 2, 1],
        11: [1, 3, 3, 4, 3, 3, 3, 4, 2, 3, 4, 2, 4, 2, 4, 2, 3, 3, 2, 3],
        12: [2, 2, 3, 2, 4, 3, 4, 2, 4, 3, 3, 1, 1, 2, 2, 2, 4, 3, 2, 4],
    }
}

# ---------------------------------------------------------
# 2. UI 설정 및 사이드바
# ---------------------------------------------------------
st.set_page_config(page_title="모의고사 OMR 채점기", layout="centered")

st.title("📝 모의고사 OMR 채점기")
st.markdown("---")

with st.sidebar:
    st.header("시험 설정")
    exam_type = st.radio("시험 종류 선택", ["진도별 모의고사", "동형 모의고사"])
    
    # 선택된 시험 종류에 따라 회차 목록 생성
    available_rounds = list(EXAM_DB[exam_type].keys())
    round_num = st.selectbox("회차 선택", available_rounds, format_func=lambda x: f"제 {x}회")
    
    st.info(f"현재 **{exam_type} {round_num}회**를 선택하셨습니다.")
    st.markdown("---")
    st.markdown("**사용 방법**\n1. 오른쪽 화면에서 답안을 마킹하세요.\n2. 하단 '채점하기' 버튼을 누르세요.\n3. 점수와 오답을 확인하세요.")

# ---------------------------------------------------------
# 3. OMR 입력 폼
# ---------------------------------------------------------
st.subheader(f"✍️ {exam_type} 제 {round_num}회 답안 입력")

# 폼을 사용하여 채점 버튼 누르기 전까지 리로딩 방지
with st.form("omr_form"):
    user_answers = {}
    
    # 5문제씩 4개의 컬럼으로 나누어 배치 (가독성 향상)
    cols = st.columns(4)
    
    for i in range(1, 21):
        col_idx = (i - 1) // 5  # 0, 1, 2, 3
        with cols[col_idx]:
            # 문제 번호와 라디오 버튼 (가로 배치)
            user_answers[i] = st.radio(
                f"{i}번", 
                options=[1, 2, 3, 4], 
                horizontal=True, 
                index=None,  # 초기 선택 없음
                key=f"q_{i}"
            )
            st.write("") # 간격 조정

    submitted = st.form_submit_button("💯 채점하기", use_container_width=True)

# ---------------------------------------------------------
# 4. 채점 로직 및 결과 표시
# ---------------------------------------------------------
if submitted:
    correct_answers = EXAM_DB[exam_type][round_num]
    score = 0
    wrong_list = []
    
    # 채점 진행
    for i in range(1, 21):
        user_ans = user_answers.get(i)
        correct_ans = correct_answers[i-1]
        
        if user_ans == correct_ans:
            score += 5
        else:
            wrong_list.append((i, user_ans, correct_ans))
    
    # 결과 출력
    st.divider()
    st.markdown(f"### 📊 채점 결과: **{score}점**")
    
    if score == 100:
        st.balloons()
        st.success("완벽합니다! 만점입니다! 🎉")
    elif score >= 80:
        st.success("훌륭한 점수입니다! 합격권이에요! 👍")
    else:
        st.warning("조금만 더 힘내세요! 오답 정리가 중요합니다. 💪")

    # 오답 노트 표시
    if wrong_list:
        st.markdown("#### ❌ 틀린 문제 확인")
        
        result_df_data = []
        for q_num, u_ans, c_ans in wrong_list:
            u_ans_display = u_ans if u_ans is not None else "미입력"
            result_df_data.append({
                "문제 번호": f"{q_num}번",
                "내가 쓴 답": u_ans_display,
                "정답": c_ans,
                "결과": "오답"
            })
        
        df = pd.DataFrame(result_df_data)
        st.table(df)
        
        st.markdown(f"> 총 **{len(wrong_list)}문제**를 틀렸습니다. 위 문제들의 개념을 다시 한 번 확인해보세요!")
