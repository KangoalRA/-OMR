import streamlit as st
import pandas as pd

# ---------------------------------------------------------
# 1. ì •ë‹µ ë°ì´í„°ë² ì´ìŠ¤ (ì§„ë„ë³„ + ë™í˜• ì™„ë²½ ë°˜ì˜)
# ---------------------------------------------------------
EXAM_DB = {
    "ì§„ë„ë³„ ëª¨ì˜ê³ ì‚¬": {
        1: [1, 1, 2, 1, 4, 3, 2, 2, 3, 3, 2, 4, 4, 3, 3, 3, 2, 3, 3, 2],
        2: [3, 1, 3, 2, 4, 1, 2, 4, 3, 2, 4, 2, 3, 1, 4, 2, 4, 3, 2, 2],
        3: [2, 2, 1, 3, 2, 2, 3, 2, 3, 4, 1, 3, 4, 2, 2, 4, 3, 2, 2, 4],
        4: [4, 2, 4, 1, 2, 1, 2, 3, 3, 3, 2, 3, 2, 1, 1, 4, 3, 4, 1, 2],
        5: [1, 2, 2, 2, 2, 4, 2, 3, 3, 2, 1, 4, 3, 2, 4, 4, 3, 2, 3, 3],
        6: [3, 1, 4, 3, 1, 1, 1, 4, 4, 4, 2, 1, 4, 4, 4, 2, 2, 3, 2, 3],
        7: [3, 4, 1, 3, 3, 3, 3, 3, 4, 1, 4, 3, 3, 1, 2, 3, 2, 4, 1, 2],
        8: [1, 3, 3, 1, 3, 3, 3, 2, 4, 2, 2, 3, 2, 2, 1, 4, 3, 1, 3, 4],
        9: [2, 2, 4, 4, 3, 2, 4, 4, 3, 3, 4, 2, 2, 3, 2, 3, 3, 1, 2, 2],
        10: [2, 3, 3, 4, 3, 2, 2, 3, 2, 4, 2, 2, 3, 2, 1, 4, 3, 1, 1, 3],
        11: [1, 2, 3, 4, 1, 2, 1, 4, 4, 3, 3, 2, 4, 4, 4, 4, 3, 4, 3, 3],
        12: [3, 1, 4, 3, 2, 4, 1, 1, 4, 1, 2, 4, 2, 3, 2, 2, 4, 4, 1, 4],
    },
    "ë™í˜• ëª¨ì˜ê³ ì‚¬": {
        1: [2, 3, 4, 4, 3, 1, 2, 3, 4, 2, 2, 3, 2, 3, 1, 4, 4, 4, 1, 3],
        2: [2, 2, 4, 3, 3, 4, 3, 3, 2, 1, 1, 1, 3, 4, 4, 2, 3, 1, 1, 3],
        3: [2, 2, 3, 4, 3, 4, 1, 2, 3, 2, 2, 1, 4, 4, 1, 2, 4, 3, 1, 2],
        4: [4, 1, 2, 2, 2, 4, 2, 3, 4, 2, 3, 4, 4, 1, 1, 4, 4, 4, 4, 1],
        5: [2, 4, 2, 2, 4, 4, 3, 4, 4, 4, 4, 3, 4, 4, 2, 2, 4, 3, 1, 1],
        6: [2, 3, 4, 2, 2, 3, 3, 4, 4, 1, 4, 2, 1, 2, 1, 2, 3, 3, 4, 1],
        7: [1, 2, 3, 4, 3, 3, 2, 2, 3, 4, 2, 1, 3, 3, 4, 4, 3, 2, 2, 2],
        8: [2, 2, 3, 3, 3, 4, 3, 4, 3, 3, 2, 3, 1, 1, 2, 4, 1, 3, 4, 3],
        9: [2, 4, 3, 1, 1, 4, 3, 3, 4, 3, 1, 3, 2, 1, 1, 1, 2, 1, 4, 1],
        10: [1, 1, 3, 3, 4, 4, 4, 3, 2, 3, 1, 3, 3, 4, 2, 1, 3, 1, 2, 1],
        11: [1, 3, 3, 4, 3, 3, 3, 4, 2, 3, 4, 2, 4, 2, 4, 2, 3, 3, 2, 3],
        12: [2, 2, 3, 2, 4, 3, 4, 2, 4, 3, 3, 1, 1, 2, 2, 2, 4, 3, 2, 4],
    }
}

# ---------------------------------------------------------
# 2. UI ì„¤ì • ë° ì‚¬ì´ë“œë°”
# ---------------------------------------------------------
# ëª¨ë°”ì¼ ì¹œí™”ì ìœ¼ë¡œ ì„¤ì • (initial_sidebar_state="auto")
st.set_page_config(page_title="ì‚¬íšŒ OMR ì±„ì ê¸°", layout="centered", initial_sidebar_state="auto")

# ëª¨ë°”ì¼ìš© CSS ì£¼ì… (ë¼ë””ì˜¤ ë²„íŠ¼ ê°„ê²© ë„“íˆê¸° ë“±)
st.markdown("""
<style>
    /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜í•˜ê¸° í¸í•˜ê²Œ ë¼ë””ì˜¤ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
    div[role="radiogroup"] > label {
        margin-right: 15px !important;
        font-size: 1.1rem !important;
    }
    /* ë¬¸ì œ ë²ˆí˜¸ í°íŠ¸ í¬ê¸° í‚¤ì›€ */
    .question-text {
        font-size: 1.2rem;
        font-weight: bold;
        padding-top: 5px;
    }
</style>
""", unsafe_allow_html=True)

st.title("ğŸ“ ì‚¬íšŒ OMR ì±„ì ê¸°")

with st.sidebar:
    st.header("âš™ï¸ ì‹œí—˜ ì„¤ì •")
    exam_type = st.radio("ì‹œí—˜ ì¢…ë¥˜", ["ì§„ë„ë³„ ëª¨ì˜ê³ ì‚¬", "ë™í˜• ëª¨ì˜ê³ ì‚¬"])
    
    available_rounds = list(EXAM_DB[exam_type].keys())
    round_num = st.selectbox("íšŒì°¨ ì„ íƒ", available_rounds, format_func=lambda x: f"ì œ {x}íšŒ")
    
    st.info(f"ì„ íƒë¨: **{exam_type} {round_num}íšŒ**")
    st.markdown("---")
    st.caption("ğŸ‘ˆ ì„¤ì •ì„ ë§ˆì¹˜ë©´ ì‚¬ì´ë“œë°”ë¥¼ ë‹«ê³ \në„“ì€ í™”ë©´ì—ì„œ ë¬¸ì œë¥¼ í‘¸ì„¸ìš”.")

# ---------------------------------------------------------
# 3. OMR ì…ë ¥ í¼ (ëª¨ë°”ì¼ ìµœì í™”: ë¦¬ìŠ¤íŠ¸ í˜•íƒœ)
# ---------------------------------------------------------
st.subheader(f"âœï¸ {exam_type} ì œ {round_num}íšŒ")
st.caption("ì •ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”. 5ë¬¸ì œë§ˆë‹¤ êµ¬ë¶„ì„ ì´ ìˆìŠµë‹ˆë‹¤.")

with st.form("omr_form"):
    user_answers = {}
    
    for i in range(1, 21):
        # 1ë¬¸ì œë‹¹ 1ê°œì˜ í–‰(Row)ì„ ì‚¬ìš©
        # col1: ë¬¸ì œ ë²ˆí˜¸ (ì¢ê²Œ), col2: ì •ë‹µ ì„ íƒ ë²„íŠ¼ (ë„“ê²Œ)
        col1, col2 = st.columns([1.5, 5]) 
        
        with col1:
            # ìˆ˜ì§ ì •ë ¬ì„ ë§ì¶”ê¸° ìœ„í•´ ë§ˆì§„ ì¡°ì •
            st.markdown(f'<div class="question-text">{i}ë²ˆ</div>', unsafe_allow_html=True)
        
        with col2:
            # label_visibility="collapsed"ë¡œ "ì„ íƒí•˜ì„¸ìš”" ê°™ì€ í…ìŠ¤íŠ¸ ìˆ¨ê¹€
            user_answers[i] = st.radio(
                f"{i}ë²ˆ ë¬¸ì œ", 
                options=[1, 2, 3, 4], 
                horizontal=True, 
                index=None, 
                label_visibility="collapsed",
                key=f"q_{i}"
            )
        
        # 5ë¬¸ì œë§ˆë‹¤ êµ¬ë¶„ì„  ì¶”ê°€ (ì‹œê°ì  í”¼ë¡œ ê°ì†Œ)
        if i % 5 == 0 and i != 20:
            st.divider()

    st.markdown("---")
    # ë²„íŠ¼ì„ í¼ì§€ë§‰í•˜ê²Œ ë§Œë“¦
    submitted = st.form_submit_button("ğŸ’¯ ì±„ì í•˜ê¸°", use_container_width=True)

# ---------------------------------------------------------
# 4. ì±„ì  ë¡œì§ ë° ê²°ê³¼ í‘œì‹œ
# ---------------------------------------------------------
if submitted:
    correct_answers = EXAM_DB[exam_type][round_num]
    score = 0
    wrong_list = []
    
    for i in range(1, 21):
        user_ans = user_answers.get(i)
        correct_ans = correct_answers[i-1]
        
        if user_ans == correct_ans:
            score += 5
        else:
            wrong_list.append((i, user_ans, correct_ans))
    
    st.divider()
    st.markdown(f"### ğŸ“Š ë‹¹ì‹ ì˜ ì ìˆ˜ëŠ”: **{score}ì **")
    
    if score == 100:
        st.balloons()
        st.success("ì™„ë²½í•©ë‹ˆë‹¤! ë§Œì ì…ë‹ˆë‹¤! ğŸ‰")
    elif score >= 80:
        st.success("í•©ê²©ê¶Œì…ë‹ˆë‹¤! í›Œë¥­í•´ìš”! ğŸ‘")
    else:
        st.warning("ì˜¤ë‹µ ì •ë¦¬ë¥¼ í†µí•´ ì•½ì ì„ ë³´ì™„í•´ë´ìš”! ğŸ’ª")

    if wrong_list:
        st.markdown("#### âŒ ì˜¤ë‹µ ë…¸íŠ¸")
        
        # ì˜¤ë‹µ í…Œì´ë¸” ìƒì„±
        result_df_data = []
        for q_num, u_ans, c_ans in wrong_list:
            u_ans_display = u_ans if u_ans is not None else "ë¯¸ì…ë ¥"
            result_df_data.append({
                "ë²ˆí˜¸": f"{q_num}ë²ˆ",
                "ë‚´ ë‹µ": u_ans_display,
                "ì •ë‹µ": c_ans,
                "ê²°ê³¼": "X"
            })
        
        df = pd.DataFrame(result_df_data)
        # ì¸ë±ìŠ¤ ìˆ¨ê¸°ê³  í…Œì´ë¸” ë³´ì—¬ì£¼ê¸°
        st.table(df)
